---
title: "Using heatmaply with gene expression data"
author: "Alan O'Callaghan"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: yes
    toc: true
    fig_width: 12
    fig_height: 10
    depth: 3  # upto three depths of headings (specified by #, ## and ###)  
    number_sections: true  ## if you want number sections at each table header
    theme: yeti  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Using heatmaply with gene expression data}
-->


```{r, echo = FALSE, message = FALSE}
library(knitr)
knitr::opts_chunk$set(
   # cache = TRUE,
   dpi = 60,
  comment = '#>',
  tidy = FALSE)

```
**Author**: Alan O'Callaghan (alan.b.ocallaghan@gmail.com)




Introduction
============

This vignette is intended to provide an overview of the use of
`heatmaply` in the analysis of biological data. In particular, 
this vignette deals with its use to visualize gene expression patterns and sample relationships in RNAseq data relating to breast cancer samples, as retrieved from from [Genomic Data Commons].

```{r}
# Let's load the packages
library(heatmaply)
library(heatmaplyExamples)
```


Data retrieval and pre-processing
=================================
The data used in this vignette is available within the package. 



In order to recreate the output you will need to manually run the code available here:


```{r, eval=FALSE}
## This script downloads the expression data for all breast cancer samples
## from GDC/TCGA, and filters them to have only the genes in the 
## PAM50 gene set

library('TCGAbiolinks')
library('SummarizedExperiment')
library('biomaRt')
library('voom')


query <- GDCquery(project = 'TCGA-BRCA',
    data.category = 'Transcriptome Profiling',
    data.type = 'Gene Expression Quantification',
    workflow.type = 'HTSeq - Counts'
)

GDCdownload(query)
data <- GDCprepare(query)

## Retain only tumour samples
ind_tumor <- colData(data)[['definition']]== 'Primary solid Tumor'
data <- data[, ind_tumor]

## Annotate using biomaRt
mart <- useDataset('hsapiens_gene_ensembl', useMart('ensembl'))
genes <- rownames(data)
symbols <- getBM(filters= 'ensembl_gene_id', 
    attributes= c('ensembl_gene_id','hgnc_symbol'), 
    values = genes, 
    mart= mart)

## Remove those not annotated
ind_nchar <- as.logical(nchar(symbols[['hgnc_symbol']]))
symbols <- symbols[ind_nchar, ]
data <- data[symbols[['ensembl_gene_id']], ]
rownames(data) <- symbols[['hgnc_symbol']]

## Subset to those annotated with a symbol here
pam50_genes <- intersect(pam50_genes, symbols[['hgnc_symbol']])



clinical_cols <- c('subtype_Integrated.Clusters..with.PAM50.',
    'subtype_ER.Status',
    'subtype_PR.Status',
    'subtype_HER2.Final.Status'
)

## Only interested in those which have all subtypes.
subtypes <- colData(data)[, clinical_cols]
ind_has_subtypes <- sapply(seq_len(nrow(subtypes)), 
    function(i) {
        all(!is.na(subtypes[i, ]))
    })
data <- data[, ind_has_subtypes]


tcga_brca_clinical <- colData(data)
tcga_brca_clinical <- tcga_brca_clinical[, clinical_cols]
colnames(tcga_brca_clinical) <- gsub('subtype_', '', colnames(tcga_brca_clinical))

stypes <- c('ER.Status', 'PR.Status', 'HER2.Final.Status')

tcga_brca_clinical[, stypes] <- lapply(tcga_brca_clinical[, stypes], 
    function(col) {
        col <- as.character(col)
        ifelse(col %in% c('Positive', 'Negative'), col, NA)
    }
)

## Set up final objects
tcga_brca_clinical <- as.data.frame(tcga_brca_clinical)
expression <- assay(data, 'HTSeq - Counts')
expression <- expression[!duplicated(rownames(expression)), ]

voomed_expression <- as.matrix(voom(expression))
raw_expression <- expression

```



Visualization of raw and voom-transformed data (all genes)
==========================================================
The R package [limma] is a commonly used statistical analysis tool using
empirical Bayes methods. This package was originally developed for micro-array data.
[voom] is a function within this package which transforms RNAseq count data in 
log2 counts per million reads, which allows it to be treated similarly.
This function was used in the present example to provide normalized expression 
values. While pre-processing the data, quantile and TMM normalization
were also applied. To compare these normalized values to raw read counts, 
the raw read counts were log~2~-transformed. 0.5 was
added to prevent infinite values resulting from `log2(0)`.

A common workflow for RNAseq differential expression analysis is to visualize
gene expression measures and sample-sample correlations using a heatmap. 
This is useful to observe whether samples appear to cluster together, for 
the purposes of identifying poor quality samples or outliers.
Furthermore, it may be useful to visualize differentially-expressed genes
alongside row annotations which indicate patient or sample sub-group.

The following examples show sample-sample correlation based on all genes 
measured. Clustering in both instances appears to be related to membrane 
receptor subtypes, as shown in the row annotation. 

When using the `heatmaply` function, notice the use of the `showticklabels` argument - by turning the labels off, the resulting heatmap is much lighter and allows fast zoom-in. The actual values can still be identified when hovering the mouse over the cells. Also, notice the use of the default color scheme chosen so to emphasize the correlation (which has low variability).


```{r, fig.width=13, fig.height=10}
cor_mat_raw_logged <- cor(log2(raw_expression + 0.5))

heatmaply(cor_mat_raw_logged, 
    row_side_colors = tcga_brca_clinical,
    main = 'Sample-sample correlation, log2 counts',
    showticklabels = c(FALSE, FALSE),
    plot_method = 'plotly')

```

The following gives very similar results:

```{r}
cor_mat_voomed <- cor(voomed_expression) 

```


```{r, fig.width=13, fig.height=10, eval = FALSE}

heatmaply(cor_mat_voomed, 
    row_side_colors = tcga_brca_clinical,
    main = 'Sample-sample correlation, log2 CPM',
    showticklabels = c(FALSE, FALSE),
    plot_method = 'plotly')

```

This is since the correlation of the values in the matrix is 1 (while the objects are not identical):

```{r}
identical(as.vector(cor_mat_voomed) ,as.vector(cor_mat_raw_logged))
cor(as.vector(cor_mat_voomed) ,as.vector(cor_mat_raw_logged))

```




Visualization of raw data (median-centered data, PAM50 genes only)
=================================================================

**The figures are omitted due to file size restructions on github, but can easily be reproduced by running the code below manually.**

Breast cancer has been studied extensively using gene expression profiling methods (see [Breast cancer gene expression]). This has lead to the identification of a number of gene sets which stratify patients into molecular subgroups.
One such gene set is commonly known as the [PAM50] gene set. In this example, we will visualize gene expression patterns using heatmaply.

Centering data before performing clustering tends to result in more meaningful cluster
assignment. This is particularly true when the measure of interest is the similarity in patterns across features, rather than the total distance between values. Furthermore,
it is typically the difference between samples which is of interest, rather than the difference between measures. Non-centered data may show that all samples measure high for one variable, and low for another, while centered data shows relative differences. Alternatively, one could use a distance measure which is invariant to total distance, such as correlation. 
Heatmaps of non-centered are shown in 
[another vignette](non_centred_heatmaps.html) within this package. It can be seen
that the concordance between the centered and non-centered heatmaps is mediocre, and 
the clustering of triple negative samples is not as definite.

In the heatmaps shown below, it is clear that samples appear to cluster loosely 
based on [PAM50] subtype more than the previous examples.
Concordance with the assigned labels shown in the row annotation 
is not complete, however this may be expected, 
given that a different clustering method was used here (hierarchical clustering,
rather than [k-medioids]).


```{r}
pam50_genes <- intersect(pam50_genes, rownames(raw_expression))
raw_pam50_expression <- raw_expression[pam50_genes, ]
voomed_pam50_expression <- voomed_expression[pam50_genes, ]

center_raw_mat <- cor_mat_raw_logged - 
    apply(cor_mat_raw_logged, 1, median)

raw_max <- max(abs(center_raw_mat), na.rm=TRUE)
raw_limits <- c(-raw_max, raw_max)

```


```{r, eval = FALSE}

heatmaply(t(center_raw_mat), 
    row_side_colors = tcga_brca_clinical,
    showticklabels = c(FALSE, FALSE),
    fontsize_col = 7.5,
    col = cool_warm(100),
    main = 'Centred log2 read counts, PAM50 genes',
    limits = raw_limits,
    plot_method = 'plotly')


```

Note that `heatmaply_cor` is just like `heatmaply` but with defaults that are better suited for correlation matrix (limits from -1 to 1, and a cold-warm color scheme).

```{r, fig.width=13, fig.height=10, eval = FALSE}
heatmaply_cor(cor(center_raw_mat), 
    row_side_colors = tcga_brca_clinical,
    showticklabels = c(FALSE, FALSE),
    main = 'Sample-sample correlation based on centred, log2 PAM50 read counts',
    plot_method = 'plotly')

```





Visualization of voom-transformed data (median-centered data, PAM50 genes only)
==================

**The figures are omitted due to file size restructions on github, but can easily be reproduced by running the code below manually.**

Following normalization, gene expression patterns appear roughly similar. 
This indicates that relative expression levels have not been altered unduly.
Furthermore, slightly increased concordance with the pre-assigned cluster labels
is observed in normalized data. Samples appear to cluster based 
Sample-sample correlation appears to show less concordance with row annotations 
than clustering based on gene expression. However, the use of different
linkage criteria or distance measures may alter the observed clusters.

```{r, eval = FALSE}
center_voom_mat <- voomed_pam50_expression - 
    apply(voomed_pam50_expression, 1, median)

voom_max <- max(abs(center_voom_mat))
voom_limits <- c(-voom_max, voom_max)


heatmaply(t(center_voom_mat), 
    row_side_colors=tcga_brca_clinical,
    fontsize_col = 7.5,
    showticklabels = c(TRUE, FALSE),
    col = cool_warm(50),
    limits = voom_limits,
    main = 'Normalised, centred log2 CPM, PAM50 genes',
    plot_method = 'plotly')

```




```{r, fig.width=13, fig.height=10, eval = FALSE}

heatmaply_cor(cor(center_voom_mat), 
    row_side_colors = tcga_brca_clinical,
    showticklabels = c(FALSE, FALSE),
    main = 'Sample-sample correlation based on centred, normalised PAM50 gene expression',
    plot_method = 'plotly')

```



Discussion
==========
It may be useful when examining expression 
heatmaps to identify particularly high or low measures for a single
gene in a group of patients, or a gene which shows unusually high or low variance.
The mouse-over text available in the `heatmaply` 
package allows visual assessment of measures of interest and quick identification
of samples or genes with unusual gene expression patterns.
Similarly, visualizing correlation heatmaps with `heatmaply` allows the user to
rapidly identify samples with unusually high or low pairwise correlation.

References
==========
- [limma]
- [voom](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29)
- [Trimmed mean of M-component normalisation][TMM]
- [Genomics Data Commons]
- [PAM50]
- [Breast cancer gene expression]
- [Partitioning around medioids]

[Partitioning around medioids]: https://en.wikipedia.org/wiki/K-medoids
[k-medioids]: https://en.wikipedia.org/wiki/K-medoids
[Genomics Data Commons]: https://gdc.cancer.gov/
[limma]: https://bioconductor.org/packages/release/bioc/html/limma.html
[TMM]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2864565/
[PAM50]: http://ascopubs.org/doi/abs/10.1200/jco.2008.18.1370
[Genomic Data Commons]: https://gdc.cancer.gov/
[data preprocessing vignette]: data_preprocessing.html
[voom]: https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29
[Breast cancer gene expression]: https://www.ncbi.nlm.nih.gov/pubmed/28733194




sessionInfo
===============

```{r}
sessionInfo()
```


